<!DOCTYPE html>
<html lang="en">  
<head>  
<meta charset="UTF-8">  
<title>Tambola</title>  
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
<style>  
  body {  
    margin: 0;  
    font-family: "Segoe UI", sans-serif;  
    background: linear-gradient(135deg, #ffecd2, #fcb69f);  
    color: #333;  
    min-height: 100vh;  
    display: flex;  
    flex-direction: column;  
    align-items: center;  
    overflow-x: hidden;  
  }  

  /* === TOP BAR === */
  .top-bar {  
    display: flex;  
    overflow-x: auto;  
    padding: 12px 16px;  
    background: linear-gradient(90deg, #ff512f, #dd2476, #24c6dc);  
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);  
    width: 100%;  
    scrollbar-width: none;  
    z-index: 10;  
    position: sticky;  
    top: 0;  
  }  
  .top-bar::-webkit-scrollbar { display: none; }  

  .player {  
    flex-shrink: 0;  
    margin: 0 14px;  
    text-align: center;  
    cursor: pointer;  
    position: relative;  
  }  
  .player span {  
    font-size: 14px;  
    display: block;  
    margin-top: 5px;  
    font-weight: 600;  
    color: #fff;  
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);  
  }  

  .player img {  
    width: 56px;  
    height: 56px;  
    border-radius: 50%;  
    border: 3px solid rgba(255,255,255,0.7);  
    box-shadow: 0 0 8px rgba(255,255,255,0.5);  
  }

  #achievementText {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: clamp(30px, 5vw, 60px);
    font-weight: 900;
    text-align: center;
    color: yellow;
    text-shadow: 0 0 8px #ffff66, 0 0 20px #ffeb3b, 0 0 30px #ffd700;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s, transform 0.5s;
  }
  #achievementText.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* === Number Overlay === */
  #numberOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    flex-wrap: wrap;
    justify-content: center;
    align-content: flex-start;
    padding: 20px;
    overflow-y: auto;
    z-index: 1000;
  }
  #numberOverlay .num {
    width: 50px; height: 50px;
    margin: 6px;
    border-radius: 8px;
    display: flex; justify-content: center; align-items: center;
    font-weight: bold;
    font-size: 18px;
    background: #eee;
    color: #333;
    transition: background 0.3s, transform 0.2s;
  }
  #numberOverlay .num.called { background: #28a745; color:#fff; transform: scale(1.1); }
  #numberOverlay .close-btn {
    position: fixed; top: 10px; right: 10px;
    background: #ff4444; color:#fff; border:none; border-radius:6px;
    padding: 8px 14px; font-size:14px; cursor:pointer;
  }

  .ticket {  
    display: grid;  
    grid-template-columns: repeat(9, 1fr);  
    border-radius: 14px;  
    box-shadow: 0 10px 28px rgba(0,0,0,0.3);  
    background: #fff;  
    width: 94%;  
    margin: 22px auto;  
    overflow: hidden;  
  }  
  .cell {  
    aspect-ratio: 0.85/1;  
    display: flex;  
    align-items: center;  
    justify-content: center;  
    font-weight: 700;  
    font-size: clamp(12px, 1.6vw, 18px);  
    border: 1px solid #ddd;  
    background: linear-gradient(145deg, #fff, #ffe);  
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s;  
  }  
  .cell.correct { background: #28a745; color:#fff; }  
  .cell.wrong { background: #dc3545; color:#fff; }  
  .cell:hover {  
    background: #ffe0d0;  
    transform: scale(1.05);  
  }  

  .btns {  
    display: flex;  
    flex-direction: column;  
    gap: 14px;  
    margin: 18px 0 24px;  
    width: 200px;  
  }  
  .stats-btn {  
    padding: 14px;  
    background: linear-gradient(135deg, #333, #555);  
    color: #fff;  
    font-size: 16px;  
    font-weight: 600;  
    border: none;  
    border-radius: 10px;  
    cursor: pointer;  
    text-align: center;  
    transition: transform 0.2s, box-shadow 0.2s;  
  }  
  .stats-btn:hover {  
    transform: translateY(-2px);  
    box-shadow: 0 4px 14px rgba(0,0,0,0.3);  
  }  

  @media (min-width: 992px) {  
    .ticket { width: 55%; max-width: 650px; }  
    .cell { aspect-ratio: 1.6/1; }  
  }  
</style>  
</head>  
<body>  

<div class="top-bar" id="topBar"></div>  
<div id="achievementText"></div>
<div id="numberOverlay"></div>  

<div class="btns">  
  <button id="startBtn" class="stats-btn" style="display:none;" onclick="startGame()">Start Game</button>
  <button class="stats-btn" onclick="toggleNumberOverlay()">Show Numbers</button>
</div>  

<div class="ticket" id="ticket"></div>  

<script>  
console.log("ðŸš€ Script loaded");

const ticketEl = document.getElementById("ticket");  
const achievementText = document.getElementById("achievementText");  
const topBar = document.getElementById("topBar");  
const numberOverlay = document.getElementById("numberOverlay");

let players = {}, playerAchievements = {}, markedNumbers = new Set();
let ticketData = [];
let calledNumbers = new Set();

const roomId = localStorage.getItem("roomId");
const playerId = localStorage.getItem("playerId");
const wscode = localStorage.getItem("wscode");
const username = localStorage.getItem("username");
const icon = localStorage.getItem("icon");
const isHost = localStorage.getItem("ishost") === "true";

if (isHost) document.getElementById("startBtn").style.display="block";

// WebSocket
const ws = new WebSocket("wss://multiplyer-game.onrender.com");
ws.onopen = () => {
  ws.send(JSON.stringify({typeReq:"pageEntered", roomId, playerId, wscode, isHost}));

  // âœ… Add self immediately
  players[playerId] = { playerId, username, icon };
  renderTopBar();
};
ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);
  if(data.type==="ijoin" || data.type==="hejoins") {
  // data.players is an array
  data.players.forEach(p => {
    players[p.playerId] = p;
  });
  renderTopBar();
  }
  if(data.type==="heleft"){ delete players[data.playerId]; renderTopBar(); }
  if(data.type==="heachieves"){ showAchievement(`${data.playerName} achieved ${data.achievement}`); updatePlayerArc(data.playerId, data.achievement);}
  if(data.type==="sendTicket"){ ticketData=data.ticket; renderTicket(ticketData);}
  if(data.type==="sendNumber"){ handleNumber(data.number);}
  if(data.type==="gameStarts"){ calledNumbers.clear(); ticketEl.innerHTML="";}
};

function startGame(){
  if(ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({typeReq:"startGame", roomId, playerId, wscode}));
}

// === TOP BAR ===
const achievementList=["First Five","First Seven","First Row","Second Row","Third Row","Full House"];
function renderTopBar(){
  topBar.innerHTML="";
  Object.values(players).forEach(p=>{
    if(!playerAchievements[p.playerId]) playerAchievements[p.playerId]=new Set();
    const div=document.createElement("div");
    div.className="player"; div.id="player-"+p.playerId; div.style.position="relative";

    const r=28,cx=35,cy=35,fullCirc=2*Math.PI*r,arcLen=fullCirc/6;
    const colors=["#ff3c00","#ff9500","#ffea00","#00ff90","#00fff2","#0095ff"];
    const arcs = colors.map((c,i)=>`<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${c}" stroke-width="4" stroke-dasharray="${arcLen} ${fullCirc}" stroke-dashoffset="${fullCirc - i*arcLen}" class="arc arc-${i}" style="opacity:0; transition: opacity 0.5s"/>`).join("");
    div.innerHTML=`<svg width="70" height="70" style="transform:rotate(-90deg)"><circle cx="${cx}" cy="${cy}" r="${r}" stroke="#ddd" stroke-width="4" fill="none"/>${arcs}</svg>
    <img src="${p.icon || 'default.png'}" style="width:56px;height:56px;border-radius:50%;position:absolute;top:7px;left:7px;"/>
    <span>${p.username || 'Player'}</span>`;
    topBar.appendChild(div);
    playerAchievements[p.playerId].forEach(ach=>{
      const idx=achievementList.indexOf(ach); if(idx>=0){ const arc=div.querySelector(".arc-"+idx); if(arc) arc.style.opacity=1; }
    });
  });
}
function updatePlayerArc(playerId, achievement){
  if(!playerAchievements[playerId]) playerAchievements[playerId]=new Set();
  const idx=achievementList.indexOf(achievement); if(idx===-1) return;
  playerAchievements[playerId].add(achievement);
  const div=document.getElementById("player-"+playerId);
  if(div){ const arc=div.querySelector(".arc-"+idx); if(arc) arc.style.opacity=1; }
}
function showAchievement(text){
  achievementText.textContent=text;
  achievementText.classList.add("show");
  setTimeout(()=>{ achievementText.classList.remove("show"); achievementText.textContent=""; },2000);
}

// === TICKET ===
function renderTicket(ticket){
  ticketEl.innerHTML="";
  ticket.flat().forEach(num=>{
    const cell=document.createElement("div"); cell.classList.add("cell");
    if(num!==null && num!=="") cell.textContent=num;
    cell.onclick=()=>playerMark(cell,num);
    ticketEl.appendChild(cell);
  });
}
function playerMark(cell,num){
  if(calledNumbers.has(num)){
    cell.classList.add("correct");
  }else{
    cell.classList.add("wrong");
    setTimeout(()=>cell.classList.remove("wrong"),2000);
  }
}

// === NUMBERS OVERLAY ===
function initNumberOverlay(){
  numberOverlay.innerHTML=`<button class="close-btn" onclick="toggleNumberOverlay()">Close</button>`;
  for(let i=1;i<=90;i++){
    const div=document.createElement("div");
    div.className="num";
    div.textContent=i;
    div.id="num-"+i;
    numberOverlay.appendChild(div);
  }
}
initNumberOverlay();

function toggleNumberOverlay(){
  numberOverlay.style.display = numberOverlay.style.display==="flex" ? "none" : "flex";
}

function handleNumber(num){
  calledNumbers.add(num);
  autoMark(num);
  const el=document.getElementById("num-"+num);
  if(el) el.classList.add("called");
}
function autoMark(num){
  document.querySelectorAll("#ticket .cell").forEach(cell=>{
    if(parseInt(cell.textContent)===num){
      cell.classList.add("correct");
    }
  });
}
</script>  
</body>  
</html>         
   
