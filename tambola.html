<!DOCTYPE html>
<html lang="en">  
<head>  
<meta charset="UTF-8">  
<title>Tambola</title>  
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
<style>  
  body {  
    margin: 0;  
    font-family: "Segoe UI", sans-serif;  
    background: url("doodle.jpg"), linear-gradient(135deg, #ffecd2, #fcb69f);  
    background-blend-mode: multiply;  
    background-size: cover;  
    color: #333;  
    min-height: 100vh;  
    display: flex;  
    flex-direction: column;  
    align-items: center;  
    overflow-x: hidden;  
  }  

  #top-bar-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 16px auto 0 auto;
    padding: 16px 24px;
    border-radius: 30px;
    background: rgba(255,255,255,0.9);
    max-width: 98%;
    width: 95%;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }

  #topBar { display: flex; gap: 28px; overflow-x: auto; flex:1; padding:10px; scroll-behavior:smooth; justify-content:center; }
  #topBar::-webkit-scrollbar { display:none; }

  .player { flex:0 0 auto; text-align:center; position:relative; transition: transform 0.2s; }
  .player:hover { transform: scale(1.05); }
  .player img { width:64px; height:64px; border-radius:50%; border:3px solid #fff; box-shadow:0 4px 12px rgba(0,0,0,0.4);}
  .player span { display:block; margin-top:6px; font-size:14px; font-weight:600; color:#222; text-shadow:0 1px 4px rgba(255,255,255,0.95); }

  #achievementText { position:fixed; top:80px; left:50%; transform:translateX(-50%); font-size:clamp(28px,5vw,54px); font-weight:900; color:yellow; text-shadow:0 0 8px #ffff66,0 0 20px #ffeb3b,0 0 30px #ffd700; pointer-events:none; z-index:9999; opacity:0; transition:opacity 0.5s, transform 0.5s; }
  #achievementText.show { opacity:1; transform:translateX(-50%) translateY(0); }

  #numberOverlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); display:none; flex-wrap:wrap; justify-content:center; align-content:flex-start; padding:20px; overflow-y:auto; z-index:1000; }
  #numberOverlay .num { width:50px; height:50px; margin:6px; border-radius:8px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:18px; background:#eee; color:#333; transition: background 0.3s, transform 0.2s; }
  #numberOverlay .num.called { background:#28a745; color:#fff; transform:scale(1.1); }
  #numberOverlay .close-btn { position:fixed; top:10px; right:10px; background:#ff4444; color:#fff; border:none; border-radius:6px; padding:8px 14px; font-size:14px; cursor:pointer; }

  .ticket { display:grid; grid-template-columns:repeat(9,1fr); border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,0.35); background:linear-gradient(145deg,#fff,#ffe); width:96%; margin:24px auto; overflow:hidden; border:2px solid #f0c67a; }  
  .cell { aspect-ratio:1.3/1; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:clamp(14px,1.6vw,20px); border:1px solid #ddd; background:linear-gradient(135deg,#fff,#ffe9d6); cursor:pointer; transition: background 0.3s ease, transform 0.2s, box-shadow 0.2s; }  
  .cell.blank { background:#fafafa; cursor:default; }  
  .cell.correct { background:#28a745; color:#fff; box-shadow:0 0 8px #28a745 inset; }  
  .cell.wrong { background:#dc3545; color:#fff; box-shadow:0 0 8px #dc3545 inset; }  
  .cell:hover:not(.blank) { background:#ffe0d0; transform:scale(1.05); box-shadow:0 2px 6px rgba(0,0,0,0.3); }  

  .btns { display:flex; flex-direction:column; gap:14px; margin:18px 0 24px; width:220px; }  
  .stats-btn { padding:14px; background:linear-gradient(135deg,#333,#555); color:#fff; font-size:16px; font-weight:600; border:none; border-radius:12px; cursor:pointer; text-align:center; transition:transform 0.2s, box-shadow 0.2s; }  
  .stats-btn:hover { transform:translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,0.35); }  

  @media (min-width:992px) { .ticket { width:60%; max-width:700px; } .cell { aspect-ratio:1.6/1; } }  
</style>  
</head>  
<body>  

<!-- === TOP BAR === -->
<div id="top-bar-wrapper">
  <div id="topBar"></div>
</div>

<div id="achievementText"></div>
<div id="numberOverlay"></div>  

<div class="btns">  
  <button id="startBtn" class="stats-btn" style="display:none;" onclick="startGame()">Start Game</button>
  <button class="stats-btn" onclick="toggleNumberOverlay()">Show Numbers</button>
</div>  

<div class="ticket" id="ticket"></div>  

<div id="slotContainer"></div>

<script>  
console.log("🚀 Script loaded");

const ticketEl = document.getElementById("ticket");  
const achievementText = document.getElementById("achievementText");  
const topBar = document.getElementById("topBar");  
const numberOverlay = document.getElementById("numberOverlay");

let players = {}, playerAchievements = {}, markedNumbers = new Set();
let ticketData = [];
let calledNumbers = new Set();

const roomId = localStorage.getItem("roomId");
const playerId = localStorage.getItem("playerId");
const wscode = localStorage.getItem("wscode");
const username = localStorage.getItem("username");
const icon = localStorage.getItem("icon");
const isHost = localStorage.getItem("ishost") === "true";

console.log("Player data:", {roomId, playerId, wscode, username, icon, isHost});

// Show start button if host
if (isHost) document.getElementById("startBtn").style.display="block";

// === IMAGE LOADER HELPER ===
function checkImage(url, name){
  const img = new Image();
  img.src = url;
  img.onload = ()=>console.log(`✅ Loaded ${name}: ${url}`);
  img.onerror = ()=>console.error(`❌ Failed to load ${name}: ${url}`);
  return url;
}

// WebSocket
const ws = new WebSocket("wss://multiplyer-game.onrender.com");
ws.onopen = () => {
  console.log("🔵 WebSocket opened");
  ws.send(JSON.stringify({typeReq:"pageEntered", roomId, playerId, wscode, isHost}));
  players[playerId] = { playerId, username, icon };
  renderTopBar();
};
ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);
  console.log("📨 WS message received:", data);
  if(data.type==="ijoin" || data.type==="hejoins") {
    data.players.forEach(p => { players[p.playerId] = p; });
    renderTopBar();
  }
  if(data.type==="heleft"){ delete players[data.playerId]; renderTopBar(); }
  if(data.type==="heachieves"){ showAchievement(`${data.playerName} achieved ${data.achievement}`); updatePlayerArc(data.playerId, data.achievement);}
  if(data.type==="sendTicket"){ ticketData=data.ticket; renderTicket(ticketData);}
  if(data.type==="sendNumber"){ handleNumber(data.number); updateSlotNumberEffect(data.number);}
  if(data.type==="gameStarts"){ calledNumbers.clear(); ticketEl.innerHTML=""; }
};

function startGame(){
  console.log("▶️ Start button clicked");
  if(ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({typeReq:"startGame", roomId, playerId, wscode}));
}

// === TOP BAR ===
function renderTopBar(){
  console.log("🔹 Rendering top bar", players);
  topBar.innerHTML="";
  Object.values(players).forEach((p,i)=>{
    if(!playerAchievements[p.playerId]) playerAchievements[p.playerId]=new Set();
    
    const iconPath = p.icon ? `/${p.icon}` : `/avt${(i % 8) + 1}.jpg`;
    checkImage(iconPath, `Player ${p.username} icon`);
    
    const div=document.createElement("div");
    div.className="player";
    div.id="player-"+p.playerId;
    div.innerHTML=`<img src="${iconPath}"><span>${p.username || 'Player'}</span>`;
    topBar.appendChild(div);
  });
}

function updatePlayerArc(playerId, achievement){
  if(!playerAchievements[playerId]) playerAchievements[playerId]=new Set();
  playerAchievements[playerId].add(achievement);
  console.log(`🏆 Player ${playerId} achievement added: ${achievement}`);
}

function showAchievement(text){
  console.log(`✨ Showing achievement: ${text}`);
  achievementText.textContent=text;
  achievementText.classList.add("show");
  setTimeout(()=>{ achievementText.classList.remove("show"); achievementText.textContent=""; },2000);
}

// === TICKET ===
function renderTicket(ticket){
  console.log("🎫 Rendering ticket:");
  ticketEl.innerHTML="";
  ticket.flat().forEach(num=>{
    const cell=document.createElement("div");
    cell.classList.add("cell");
    if(num===null || num===""){ 
      cell.classList.add("blank"); 
    } else {
      cell.textContent=num;
      cell.onclick=()=>playerMark(cell,num);
    }
    ticketEl.appendChild(cell);
  });
}

function playerMark(cell,num){
  if(calledNumbers.has(num)){
    cell.classList.add("correct");
    console.log(`✅ Correct mark on number: ${num}`);
  }else{
    cell.classList.add("wrong");
    console.log(`❌ Wrong mark on number: ${num}`);
    setTimeout(()=>cell.classList.remove("wrong"),2000);
  }
}

// === NUMBERS OVERLAY ===
function initNumberOverlay(){
  console.log("🔢 Initializing number overlay");
  numberOverlay.innerHTML=`<button class="close-btn" onclick="toggleNumberOverlay()">Close</button>`;
  for(let i=1;i<=90;i++){
    const div=document.createElement("div");
    div.className="num";
    div.textContent=i;
    div.id="num-"+i;
    numberOverlay.appendChild(div);
  }
}
initNumberOverlay();

function toggleNumberOverlay(){ 
  numberOverlay.style.display = numberOverlay.style.display==="flex" ? "none" : "flex"; 
  console.log(`🔢 Number overlay ${numberOverlay.style.display}`);
}

function handleNumber(num){
  console.log(`🎯 Number called: ${num}`);
  calledNumbers.add(num);
  autoMark(num);
  const el=document.getElementById("num-"+num);
  if(el) el.classList.add("called");
}

function autoMark(num){
  document.querySelectorAll("#ticket .cell").forEach(cell=>{
    if(parseInt(cell.textContent)===num){ 
      cell.classList.add("correct"); 
      console.log(`✅ Auto marked ${num} on ticket`);
    }
  });
}

// === SLOT REEL ===
console.log("🎰 Loading slot SVG...");
fetch("/use.svg")
  .then(res => res.text())
  .then(svg => {
    // Ensure no white background in loaded SVG
    const cleanSvg = svg.replace(/pagecolor="#ffffff"/g,"").replace(/fill="#ffffff"/g,"fill='none'");
    document.getElementById("slotContainer").innerHTML = cleanSvg;
  })
  .catch(err => console.error("❌ Error loading SVG:", err));

function updateSlotNumberEffect(num){
  const digits = num.toString().padStart(2,'0').split('');
  const t1 = document.querySelector("#slotContainer #tspan9");
  const t2 = document.querySelector("#slotContainer #tspan10");
  if(t1 && t2){
    [t1,t2].forEach((el,i)=>{
      let final = parseInt(digits[i]);
      let current = 0;
      const interval = setInterval(()=>{ el.textContent = current; current = (current+1)%10; },50);
      setTimeout(()=>{ clearInterval(interval); el.textContent=final; },800);
    });
  }
}
</script>  
</body>  
</html>
