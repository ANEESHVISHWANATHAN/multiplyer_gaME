<!DOCTYPE html>
<html lang="en">  
<head>  
  <meta charset="UTF-8">  
  <title>Tambola</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
  <style>  
    body {  
      margin: 0;  
      font-family: "Segoe UI", sans-serif;  
      background: linear-gradient(135deg, #ffecd2, #fcb69f);  
      color: #333;  
      min-height: 100vh;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      overflow-x: hidden;  
    }  

    .top-bar {  
      display: flex;  
      overflow-x: auto;  
      padding: 12px 16px;  
      background: #fff;  
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);  
      width: 100%;  
      scrollbar-width: none;  
      z-index: 10;  
      position: sticky;  
      top: 0;  
    }  
    .top-bar::-webkit-scrollbar { display: none; }  
    .player { flex-shrink: 0; margin: 0 12px; text-align: center; cursor: pointer; }  
    .player img { width: 56px; height: 56px; border-radius: 50%; border: 2px solid #ccc; object-fit: cover; }  
    .player span { font-size: 14px; display: block; margin-top: 5px; }  

    .number-shower {  
      margin: 20px 0;  
      font-size: clamp(22px, 5vw, 42px);  
      font-weight: bold;  
      color: #fff;  
      background: linear-gradient(135deg, #ff416c, #ff4b2b);  
      padding: 16px 38px;  
      border-radius: 20px;  
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);  
      min-width: 120px;  
      text-align: center;  
      letter-spacing: 1px;  
    }  

    .ticket {  
      display: grid;  
      grid-template-columns: repeat(9, 1fr);  
      border: 4px solid #ff4b2b;  
      border-radius: 14px;  
      box-shadow: 0 10px 28px rgba(0,0,0,0.3);  
      background: #fff8f0;  
      width: 94%;  
      margin: 22px auto;  
      overflow: hidden;  
    }  
    .cell {  
      aspect-ratio: 0.85/1;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      font-weight: 700;  
      font-size: clamp(12px, 1.6vw, 18px);  
      border: 1px solid #ddd;  
      background: #fff;  
      transition: background 0.3s ease, transform 0.2s;  
    }  
    .cell:hover {  
      background: #ffe0d0;  
      transform: scale(1.05);  
    }  
    .highlight {   
      background: #ffcc80 !important;   
      font-weight: 800;   
      color: #222;  
    }  

    .btns {  
      display: flex;  
      flex-direction: column;  
      gap: 14px;  
      margin: 18px 0 24px;  
      width: 200px;  
    }  
    .stats-btn {  
      padding: 14px;  
      background: linear-gradient(135deg, #333, #555);  
      color: #fff;  
      font-size: 16px;  
      font-weight: 600;  
      border: none;  
      border-radius: 10px;  
      cursor: pointer;  
      text-align: center;  
      transition: transform 0.2s, box-shadow 0.2s;  
    }  
    .stats-btn:hover {  
      transform: translateY(-2px);  
      box-shadow: 0 4px 14px rgba(0,0,0,0.3);  
    }  

    .overlay {  
      position: fixed;  
      top: 0; left: 0;  
      width: 100%; height: 100%;  
      display: flex;  
      justify-content: center;  
      align-items: center;  
      z-index: 1000;  
      backdrop-filter: blur(8px);  
      visibility: hidden;  
    }  

    .overlay-box {  
      position: relative;  
      width: 90%;  
      max-width: 900px;  
      max-height: 75%;  
      margin: 15% auto;  
      border: 14px solid #ff2d55;  
      border-radius: 20px;  
      background: rgba(15, 15, 30, 0.95);  
      box-shadow: 0 0 20px rgba(255, 45, 85, 0.6),  
                  inset 0 0 12px rgba(255,255,255,0.1);  
      overflow-y: auto;  
      padding: 30px 20px;  
      transform: translateY(100%);  
      transition: transform 0.5s ease-in-out;  
    }  

    .overlay.active { visibility: visible; }  
    .overlay.active .overlay-box { transform: translateY(0); }  

    .close-btn {  
      position: absolute;  
      font-size: 20px;  
      color: #ff2d55;  
      background: #fff;  
      border-radius: 50%;  
      width: 32px; height: 32px;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      cursor: pointer;  
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);  
      z-index: 1101;  
    }  
    @media (orientation: landscape) {  
      .close-btn { top: 10px; right: 10px; }  
    }  
    @media (orientation: portrait) {  
      .close-btn { top: 10px; left: 50%; transform: translateX(-50%); }  
    }  

    .lb-row {  
      display: flex;  
      align-items: center;  
      justify-content: space-between;  
      padding: 12px;  
      font-size: 16px;  
      font-weight: bold;  
      color: #fff;  
      background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,45,85,0.3));  
      border-radius: 10px;  
      margin-bottom: 10px;  
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);  
    }  
    .lb-info { display: flex; align-items: center; gap: 10px; }  
    .lb-info img {  
      width: 38px; height: 38px;  
      border-radius: 50%;  
      border: 2px solid #fff;  
    }  

    .numbers-grid { display: grid; gap: 6px; justify-items: center; }  
    .num-cell {  
      width: 34px; height: 34px;  
      display: flex; align-items: center; justify-content: center;  
      border-radius: 6px;  
      font-size: 14px;  
      font-weight: bold;  
      color: #fff;  
      background: #b22222;  
    }  
    .num-cell.called { background: #228b22; }  

    /* Achievement overlay */
    #achievementText {
      position: fixed;
      top: 30%;
      left: -100%;
      font-size: clamp(40px, 6vw, 80px);
      font-weight: 900;
      text-align: center;
      color: yellow;
      text-shadow: 0 0 8px #ffff66, 0 0 20px #ffeb3b, 0 0 30px #ffd700;
      pointer-events: none;
      z-index: 9999;
      white-space: nowrap;
      transform: translateX(0);
    }

    @keyframes slideAchievement {
      0% { left: -100%; }
      20% { left: 50%; transform: translateX(-50%); }
      80% { left: 50%; transform: translateX(-50%); }
      100% { left: 110%; transform: translateX(0); }
    }

    #achievementText.show {
      animation: slideAchievement 2s ease-in-out forwards;
    }

    @media (min-width: 992px) {  
      .ticket { width: 55%; max-width: 650px; }  
      .cell { aspect-ratio: 1.6/1; }  
      .overlay-box { margin: 15% auto; width: 70%; }  
      .numbers-grid { grid-template-columns: repeat(10, 1fr); }  
      .num-cell { width: 40px; height: 40px; font-size: 15px; }  
    }  

    @media (max-width: 576px) and (orientation: portrait) {  
      .ticket { width: 96%; }  
      .cell { aspect-ratio: 0.7/1; }  
      .overlay-box { margin: 10% auto; width: 90%; }  
      .numbers-grid { grid-template-columns: repeat(8, 1fr); }  
      .num-cell { width: 32px; height: 32px; font-size: 13px; }  
    }  

    @media (max-width: 992px) and (orientation: landscape) {  
      .ticket { width: 80%; }  
      .cell { aspect-ratio: 1.4/1; }  
      .overlay-box { margin: 10% auto; width: 75%; max-height: 65%; }  
      .numbers-grid { grid-template-columns: repeat(10, 1fr); }  
    }  
  </style>  
</head>  
<body>  
  <!-- Only host should see Start button -->

  <div class="top-bar" id="topBar"></div>  

  <div id="numberShower" class="number-shower">--</div>  

  <div class="ticket" id="ticket"></div>  

  <div class="btns">  
    <button class="stats-btn" onclick="openLeaderboard()">Leaderboard</button>  
    <button class="stats-btn" onclick="openNumbers()">Numbers</button> 
    <button id="startBtn" class="stats-btn" style="display:none;" onclick="startGame()">Start Game</button>
  </div>  

  <div class="overlay" id="leaderboard">  
    <span class="close-btn" onclick="closeLeaderboard()">‚ùå</span>  
    <div class="overlay-box">  
      <div id="lb-rows"></div>  
    </div>  
  </div>  

  <div class="overlay" id="numbersChart">  
    <span class="close-btn" onclick="closeNumbers()">‚ùå</span>  
    <div class="overlay-box">  
      <div class="numbers-grid" id="numbersGrid"></div>  
    </div>  
  </div>  

  <div id="achievementText"></div>

  <script>  
    const ticketEl = document.getElementById("ticket");  
    const achievementText = document.getElementById("achievementText");  
    

    const numberShower = document.getElementById("numberShower");  
    let calledNumbers = new Set();  
    function showLotteryNumber(finalNum){  
      let count = 0;  
      const spin = setInterval(() => {  
        numberShower.textContent = Math.floor(Math.random() * 90) + 1;  
        if(++count > 15){  
          clearInterval(spin);  
          numberShower.textContent = finalNum;  
          calledNumbers.add(finalNum);  
          updateNumbersGrid();  
        }  
      }, 100);  
    }  
    

    let playersLocal = [  
      {name:"Alice", score:45, icon:"https://via.placeholder.com/32"},  
      {name:"Bob", score:39, icon:"https://via.placeholder.com/32"},  
      {name:"Charlie", score:28, icon:"https://via.placeholder.com/32"}  
    ];  

    function renderLeaderboard(){  
      playersLocal.sort((a,b) => b.score - a.score);  
      const lb = document.getElementById("lb-rows");  
      lb.innerHTML = "";  
      playersLocal.forEach(p => {  
        const row = document.createElement("div");  
        row.className = "lb-row";  
        row.innerHTML = `
          <div class="lb-info">  
            <img src="${p.icon}">  
            <span>${p.name}</span>  
          </div>  
          <span>${p.score}</span>`;  
        lb.appendChild(row);  
      });  
    }  

    function openLeaderboard(){ renderLeaderboard(); document.getElementById("leaderboard").classList.add("active"); }  
    function closeLeaderboard(){ document.getElementById("leaderboard").classList.remove("active"); }  

    function createNumbersGrid(){  
      const grid = document.getElementById("numbersGrid");  
      for(let i=1;i<=90;i++){  
        const div = document.createElement("div");  
        div.className = "num-cell";  
        div.textContent = i;  
        grid.appendChild(div);  
      }  
    }  
    function updateNumbersGrid(){  
      document.querySelectorAll(".num-cell").forEach(cell => {  
        const val = parseInt(cell.textContent);  
        if(calledNumbers.has(val)) cell.classList.add("called");  
      });  
    }  
    createNumbersGrid();  

    function openNumbers(){ updateNumbersGrid(); document.getElementById("numbersChart").classList.add("active"); }  
    function closeNumbers(){ document.getElementById("numbersChart").classList.remove("active"); }  

    const topBar = document.getElementById("topBar");  
    let players = {};  

    function renderTopBar(){  
      topBar.innerHTML = "";  
      Object.values(players).forEach(p => {  
        const div = document.createElement("div");  
        div.className = "player";  
        div.innerHTML = `<img src="${p.icon}"><span>${p.username}</span>`;  
        topBar.appendChild(div);  
      });  
    }  

    const roomId = localStorage.getItem("roomId");
const playerId = localStorage.getItem("playerId");
const wscode = localStorage.getItem("wscode");
const username = localStorage.getItem("username");
const icon = localStorage.getItem("icon");
const isHost = localStorage.getItem("ishost") === "true";
const gameType = localStorage.getItem("gameType") || "public";

// ===== WebSocket Connection =====
const ws = new WebSocket("wss://multiplyer-game.onrender.com");

ws.onopen = () => {
    console.log("‚úÖ Connected to WS");
    ws.send(JSON.stringify({
        typeReq: "pageEntered",
        roomId,
        playerId,
        wscode,
        isHost,
        gameType
    }));
};
// Show Start Game button only for host
if (isHost) {
  document.getElementById("startBtn").style.display = "block";
}
 function startGame() {
  if(ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      typeReq: "startGame",
      roomId,
      playerId,
      wscode
    }));
  }
}   
// ===== WebSocket message handler =====
ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    console.log("üì© WS:", data);

    // ===== Initial lobby / players list =====
    if(data.type === "ijoin" || data.type === "playersReshuffled") {
        data.players.forEach(p => { players[p.playerId] = p; });
        renderTopBar();
    }

    // ===== Player joined =====
    if(data.type === "hejoins") {
        players[data.player.playerId] = data.player;
        renderTopBar();
    }

    // ===== Player left =====
    if(data.type === "heleft") {
        if(players[data.playerId]) delete players[data.playerId];
        renderTopBar();
    }

    // ===== Player achievement =====
    if(data.type === "heachieves") {
        showAchievement(`${data.playerName || "Player"} achieved ${data.achievement}`);
    }

    // ===== Ticket update =====
    if(data.type === "sendTicket") {
        ticketData = data.ticket;
        renderTicket(ticketData);
    }

    // ===== Number drawn =====
    if(data.type === "sendNumber") {
        const num = data.number;
        numberShower.textContent = num;
        calledNumbers.add(num);
        highlightTicket(num);
        updateNumbersGrid();
        if(ticketData && ticketData.length) {
  markNumber(num);
}
    }

    // ===== Game start =====
    if(data.type === "gameStarts") {
        console.log("üéÆ Game started!");
        calledNumbers.clear();
        numberShower.textContent = "--";
        ticketEl.innerHTML = "";
    }
};

// ===== Helper Functions =====
function renderTopBar() {
    topBar.innerHTML = "";
    Object.values(players).forEach(p => {
        const div = document.createElement("div");
        div.className = "player";
        div.innerHTML = `<img src="${p.icon}"><span>${p.username}</span>`;
        topBar.appendChild(div);
    });
}

function renderTicket(ticket) {
    ticketEl.innerHTML = "";
    ticket.flat().forEach(num => {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        if(num !== null && num !== "") cell.textContent = num;
        ticketEl.appendChild(cell);
    });
}

function createNumbersGrid() {
    numbersGrid.innerHTML = "";
    for(let i = 1; i <= 90; i++) {
        const div = document.createElement("div");
        div.className = "num-cell";
        div.textContent = i;
        numbersGrid.appendChild(div);
    }
}
createNumbersGrid();

function updateNumbersGrid() {
    document.querySelectorAll(".num-cell").forEach(cell => {
        const val = parseInt(cell.textContent);
        if(calledNumbers.has(val)) cell.classList.add("called");
        else cell.classList.remove("called");
    });
}

function highlightTicket(num) {
    document.querySelectorAll("#ticket .cell").forEach(cell => {
        if(parseInt(cell.textContent) === num) {
            cell.classList.add("highlight");
        }
    });
}

// ===== Achievement overlay =====
function showAchievement(text) {
    achievementText.textContent = text;
    achievementText.classList.remove("show");
    void achievementText.offsetWidth; // trigger reflow
    achievementText.classList.add("show");
    setTimeout(() => {
        achievementText.classList.remove("show");
        achievementText.textContent = "";
    }, 2000);
}

// ===== Send achievement =====
function sendAchievement(name) {
    showAchievement(name);
    if(ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            typeReq: "Iachieve",
            roomId,
            playerId,
            wscode,
            achievement: name
        }));
    }
}
// ===== Track ticket state & achievements =====
let ticketData = []; 
let markedNumbers = new Set();
let claimedAchievements = new Set();

function markNumber(num) {
  // Add to marked set if exists in ticket
  if(ticketData.flat().includes(num)) {
    markedNumbers.add(num);
    checkAchievements();
  }
}

function checkAchievements() {
  const newOnes = [];

  // Early Five & Seven
  if(markedNumbers.size >= 5 && !claimedAchievements.has("First Five")) {
    newOnes.push("First Five");
  }
  if(markedNumbers.size >= 7 && !claimedAchievements.has("First Seven")) {
    newOnes.push("First Seven");
  }

  // Row checks
  for(let r=0;r<3;r++) {
    const rowNums = ticketData[r].filter(n => n !== null);
    if(rowNums.length > 0 && rowNums.every(n => markedNumbers.has(n))) {
      if(r===0 && !claimedAchievements.has("First Row")) newOnes.push("First Row");
      if(r===1 && !claimedAchievements.has("Second Row")) newOnes.push("Second Row");
      if(r===2 && !claimedAchievements.has("Third Row")) newOnes.push("Third Row");
    }
  }

  // Full House
  const allNums = ticketData.flat().filter(n => n !== null);
  if(allNums.length > 0 && allNums.every(n => markedNumbers.has(n)) && !claimedAchievements.has("Full House")) {
    newOnes.push("Full House");
  }

  // Trigger achievements
  newOnes.forEach(name => {
    claimedAchievements.add(name);
    sendAchievement(name);
  });
}
    // Example: sendAchievement("First Five!");
    // You can call sendAchievement("Full House") or any milestone
  </script>  
</body>  
</html>
