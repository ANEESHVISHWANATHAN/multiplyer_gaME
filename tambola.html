<!DOCTYPE html>
<html lang="en">  
<head>  
  <meta charset="UTF-8">  
  <title>Tambola</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
  <style>  
    /* --- your existing CSS kept same --- */
    body{margin:0;font-family:"Segoe UI",sans-serif;background:linear-gradient(135deg,#ffecd2,#fcb69f);color:#333;min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden}
    .top-bar{display:flex;overflow-x:auto;padding:12px 16px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.1);width:100%;scrollbar-width:none;z-index:10;position:sticky;top:0}
    .top-bar::-webkit-scrollbar{display:none}
    .player{flex-shrink:0;margin:0 12px;text-align:center;cursor:pointer;position:relative}
    .player img{width:56px;height:56px;border-radius:50%;border:2px solid #ccc;object-fit:cover}
    .player .arc { position:absolute; left:0; top:0; width:56px; height:56px; pointer-events:none; }
    .player .label { position:absolute; top:-18px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:#fff; padding:4px 8px; border-radius:12px; font-size:12px; display:none; white-space:nowrap; }
    .player span{font-size:14px;display:block;margin-top:5px}
    .number-shower{margin:20px 0;font-size:clamp(22px,5vw,42px);font-weight:bold;color:#fff;background:linear-gradient(135deg,#ff416c,#ff4b2b);padding:16px 38px;border-radius:20px;box-shadow:0 6px 20px rgba(0,0,0,0.25);min-width:120px;text-align:center;letter-spacing:1px}
    .ticket{display:grid;grid-template-columns:repeat(9,1fr);border:4px solid #ff4b2b;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,0.3);background:#fff8f0;width:94%;margin:22px auto;overflow:hidden; padding:8px}
    .cell{aspect-ratio:0.85/1;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:clamp(12px,1.6vw,18px);border:1px solid #ddd;background:#fff;transition:background .3s ease,transform .2s; border-radius:8px}
    .cell:hover{background:#ffe0d0;transform:scale(1.03)}
    .cell.empty{background:transparent;border:1px dashed rgba(0,0,0,0.06)}
    .cell.highlight{background:linear-gradient(90deg,#ffe082,#ffd54f) !important; color:#111}
    .cell.matched{background:linear-gradient(90deg,#a5d6a7,#66bb6a); color:#fff}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(8px);visibility:hidden}
    .overlay-box{position:relative;width:90%;max-width:900px;max-height:75%;margin:15% auto;border:14px solid #ff2d55;border-radius:20px;background:rgba(15,15,30,.95);box-shadow:0 0 20px rgba(255,45,85,.6),inset 0 0 12px rgba(255,255,255,.1);overflow-y:auto;padding:30px 20px;transform:translateY(100%);transition:transform .5s ease-in-out}
    .overlay.active{visibility:visible}
    .overlay.active .overlay-box{transform:translateY(0)}
    .achievement-fullscreen {
      position:fixed; left:0; top:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; z-index:2000; background:linear-gradient(120deg, rgba(0,0,0,0.55), rgba(255,255,255,0.02));
      visibility:hidden; opacity:0; transition:opacity .25s ease;
    }
    .achievement-fullscreen.show{ visibility:visible; opacity:1 }
    .achievement-card{ background: #fff; padding:28px 36px; border-radius:18px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.35); max-width:90%; transform:scale(.98); transition:transform .25s ease }
    .achievement-card h1{ font-size:40px; margin:0 0 10px }
    .achievement-card p{ font-size:18px; margin:0 0 12px; color:#444 }

    .lb-row{display:flex;align-items:center;justify-content:space-between;padding:12px;font-size:16px;font-weight:bold;color:#fff;background:linear-gradient(90deg,rgba(255,255,255,.1),rgba(255,45,85,.3));border-radius:10px;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    .lb-info{display:flex;align-items:center;gap:10px}
    .lb-info img{width:38px;height:38px;border-radius:50%;border:2px solid #fff}
    .numbers-grid{display:grid;gap:6px;justify-items:center}
    .num-cell{width:34px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:6px;font-size:14px;font-weight:bold;color:#fff;background:#b22222}
    .num-cell.called{background:#228b22}
    @media(min-width:992px){.ticket{width:55%;max-width:650px}.cell{aspect-ratio:1.6/1}.overlay-box{margin:15% auto;width:70%}.numbers-grid{grid-template-columns:repeat(10,1fr)}.num-cell{width:40px;height:40px;font-size:15px}}
    @media(max-width:576px) and (orientation:portrait){.ticket{width:96%}.cell{aspect-ratio:.7/1}.overlay-box{margin:10% auto;width:90%}.numbers-grid{grid-template-columns:repeat(8,1fr)}.num-cell{width:32px;height:32px;font-size:13px}}
    @media(max-width:992px) and (orientation:landscape){.ticket{width:80%}.cell{aspect-ratio:1.4/1}.overlay-box{margin:10% auto;width:75%;max-height:65%}.numbers-grid{grid-template-columns:repeat(10,1fr)}}
  </style>  
</head>  
<body>  
  <div class="top-bar" id="topBar"></div>  

  <div id="numberShower" class="number-shower">--</div>  

  <div class="ticket" id="ticket"></div>  

  <div class="btns">  
    <button class="stats-btn" onclick="openLeaderboard()">Leaderboard</button>  
    <button class="stats-btn" onclick="openNumbers()">Numbers</button>  
    <button id="startBtn" class="stats-btn" style="display:none;">Start Game</button>  
  </div>  

  <div class="overlay" id="leaderboard">  
    <span class="close-btn" onclick="closeLeaderboard()">❌</span>  
    <div class="overlay-box"><div id="lb-rows"></div></div>  
  </div>  

  <div class="overlay" id="numbersChart">  
    <span class="close-btn" onclick="closeNumbers()">❌</span>  
    <div class="overlay-box"><div class="numbers-grid" id="numbersGrid"></div></div>  
  </div>  

  <!-- Achievement fullscreen -->
  <div id="achievementFS" class="achievement-fullscreen">
    <div class="achievement-card" id="achievementCard">
      <h1 id="achTitle"></h1>
      <p id="achDesc"></p>
      <button onclick="hideAchievement()" class="stats-btn">Close</button>
    </div>
  </div>

  <script>  
    const ticketEl=document.getElementById("ticket");  
    const numberShower=document.getElementById("numberShower");  
    let calledNumbers=new Set();  
    const topBar=document.getElementById("topBar");  
    let players={};  

    function renderTopBar(){  
      topBar.innerHTML="";  
      Object.values(players).forEach(p=>{  
        const div=document.createElement("div");  
        div.className="player";  
        div.innerHTML=`
          <div class="label" id="label-${p.playerId}"></div>
          <img src="${p.icon}" id="icon-${p.playerId}">
          <svg class="arc" id="arc-${p.playerId}" viewBox="0 0 56 56">
            <defs><linearGradient id="g${p.playerId}" x1="0" x2="1"><stop offset="0%" stop-color="#ffd54f"/><stop offset="100%" stop-color="#ff7043"/></linearGradient></defs>
            <circle cx="28" cy="28" r="26" fill="none" stroke="rgba(0,0,0,0.06)" stroke-width="4"></circle>
            <path d="" stroke="url(#g${p.playerId})" stroke-width="4" fill="none" stroke-linecap="round" id="arcpath-${p.playerId}"></path>
          </svg>
          <span>${p.username}</span>
        `;
        topBar.appendChild(div);
      });  
    }  

    function setPlayerAchievementLabel(playerId, text) {
      const lbl = document.getElementById(`label-${playerId}`);
      if (!lbl) return;
      lbl.textContent = text;
      lbl.style.display = "block";
      setTimeout(()=> { lbl.style.display = "none"; }, 7000);
    }

    function highlightArc(playerId) {
      // simple animation: set a partial arc path for the icon
      const pathEl = document.getElementById(`arcpath-${playerId}`);
      if (!pathEl) return;
      // create an arc path (circular arc) using stroke-dasharray with circle circumference
      pathEl.setAttribute("d", "M3 28a25 25 0 1 0 50 0"); // full circle path template
      pathEl.style.strokeDasharray = "80";
      pathEl.style.strokeDashoffset = "80";
      pathEl.style.transition = "stroke-dashoffset 1s ease";
      setTimeout(()=> { pathEl.style.strokeDashoffset = "0"; }, 10);
    }

    function createNumbersGrid(){  
      const grid=document.getElementById("numbersGrid");  
      for(let i=1;i<=90;i++){  
        const div=document.createElement("div");  
        div.className="num-cell";  
        div.textContent=i;  
        grid.appendChild(div);  
      }  
    }  
    createNumbersGrid();  
    function updateNumbersGrid(){  
      document.querySelectorAll(".num-cell").forEach(cell=>{  
        const val=parseInt(cell.textContent);  
        if(calledNumbers.has(val)) cell.classList.add("called");  
      });  
    }  

    function showNumber(num) {
      if (!num) return;
      numberShower.textContent = num;
      calledNumbers.add(num);
      updateNumbersGrid();
      document.querySelectorAll(".cell").forEach(c => {
        if (parseInt(c.textContent) === num) c.classList.add("matched");
      });
    }

    // renderTicket expects a 3x9 array with nulls
    function renderTicket(ticket) {
      ticketEl.innerHTML = "";
      // safety: if ticket is flat 15 list, convert to 3x9 empty layout (but server sends 3x9)
      let matrix = ticket;
      if (!Array.isArray(ticket) || !Array.isArray(ticket[0]) ) {
        // fallback: create 3x9 and fill 15 numbers
        const arr = Array.isArray(ticket) ? ticket.slice(0,15) : [];
        matrix = Array.from({length:3},()=>Array(9).fill(null));
        let idx=0;
        for (let r=0;r<3;r++){
          for (let c=0;c<9 && idx<arr.length;c++){
            matrix[r][c] = arr[idx++] || null;
          }
        }
      }
      matrix.forEach(row => {
        row.forEach(cellVal => {
          const d = document.createElement("div");
          d.classList.add("cell");
          if (cellVal === null || cellVal === "" || typeof cellVal === 'undefined') {
            d.classList.add("empty");
            d.textContent = "";
          } else {
            d.textContent = cellVal;
          }
          ticketEl.appendChild(d);
        });
      });
    }

    function showAchievementFullscreen(title, desc) {
      document.getElementById("achTitle").textContent = title;
      document.getElementById("achDesc").textContent = desc || "";
      const fs = document.getElementById("achievementFS");
      fs.classList.add("show");
    }
    function hideAchievement(){
      document.getElementById("achievementFS").classList.remove("show");
    }

    const roomId=localStorage.getItem("roomId");  
    const playerId=Number(localStorage.getItem("playerId"));  
    const wscode=localStorage.getItem("wscode");  
    const username=localStorage.getItem("username");  
    const icon=localStorage.getItem("icon");  
    const isHost=localStorage.getItem("ishost")==="true";  
    const gameType=localStorage.getItem("gameType")||"public";  

    const ws=new WebSocket("wss://multiplyer-game.onrender.com");  

    ws.onopen=()=>{  
      console.log("✅ Connected to WS");  
      ws.send(JSON.stringify({  
        typeReq:"pageEntered",roomId,playerId,wscode,isHost,gameType  
      }));  
      if(isHost){ document.getElementById("startBtn").style.display="block"; }  
    };  

    ws.onmessage=(msg)=>{  
      const data=JSON.parse(msg.data);  
      console.log("📩",data);  

      if(data.type==="ijoin"){  
        data.players.forEach(p=>{players[p.playerId]=p;});  
        renderTopBar();  
      }  
      if(data.type==="hejoins"){  
        players[data.player.playerId]=data.player;  
        renderTopBar();  
      }  
      if(data.type==="heleft"){  
        delete players[data.playerId];  
        renderTopBar();  
      }  
      if(data.type==="gameStarts" || data.type==="gameStarts" ){  
        // show a local notice
        // optionally use showAchievementFullscreen for "Game Started"
        // small toast:
        showAchievementFullscreen("Game Started", "Good luck!");
        setTimeout(hideAchievement, 2000);
      }  
      if(data.type==="sendTicket"){  
        renderTicket(data.ticket);  
      }  
      if(data.type==="sendNumber"){  
        showNumber(data.number);  
      }  
      if(data.type==="heachieve"){  
        // another player claimed achievement
        const { achievement, playerId: pid, username } = data;
        setPlayerAchievementLabel(pid, `${username} claimed ${achievement}`);
        highlightArc(pid);
      }  
    };  

    // send achievement to server
    function claimAchievement(achievementType) {
      ws.send(JSON.stringify({
        typeReq: "iachieve",
        roomId,
        playerId,
        achievement: achievementType
      }));
      // show local big fullscreen message & highlight cells as needed
      showAchievementFullscreen(achievementType, "You claimed " + achievementType + "!");
      // Hide after 4s
      setTimeout(hideAchievement, 4000);
    }

    // example: if you detect FirstFive locally call claimAchievement("First Five")
    // (detection logic not implemented here — integrate into your marking logic)

    document.getElementById("startBtn").onclick = () => {
      ws.send(JSON.stringify({
        typeReq: "startGame",
        roomId,
        playerId,
        isHost   // client flag sent so server can cross-check
      }));
    };

    function openLeaderboard(){document.getElementById("leaderboard").classList.add("active");}  
    function closeLeaderboard(){document.getElementById("leaderboard").classList.remove("active");}  
    function openNumbers(){updateNumbersGrid();document.getElementById("numbersChart").classList.add("active");}  
    function closeNumbers(){document.getElementById("numbersChart").classList.remove("active");}  
  </script>  
</body>  
</html>                
