<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Tambola â€” Polished Ticket (WS integrated)</title>
<style>
  :root{
    --accent:#ffd54f;
    --bg1:#f3cfe6;
    --bg2:#2b2f5a;
    --panel-bg: rgba(255,255,255,0.06);
    --peach: #f4c7af;
    --black-frame: #000;
    --ticket-width-mobile: 80%;
    --ticket-width-desktop: 50%;
    --cell-max:96px;
    --cell-radius:8px;
  }
  html,body{height:100%;margin:0;padding:0;}
  body{
    min-height:100vh;
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#111;
    -webkit-font-smoothing:antialiased;
    overflow-x:hidden;
    padding-bottom:40px;
  }

  .wrap{
    width:100%;
    max-width:1200px;
    padding:18px 20px;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }

  /* top bar (avatars) */
  .top-bar{
    width:100%;
    display:flex;
    gap:12px;
    padding:10px;
    background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:14px;
    box-shadow:0 8px 28px rgba(0,0,0,0.12);
    overflow-x:auto;
    -webkit-overflow-scrolling: touch; /* smoother scrolling on iOS */
  }
  .top-bar::-webkit-scrollbar{display:none;}
  .player-block{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:88px;}
  .avatar{position: relative;width: 56px;height:56px;border-radius:50%;padding:6px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 22px rgba(0,0,0,0.12);cursor:pointer;}
  .avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
  .player-name{font-size:12px;color:#fff;opacity:.95;width:88px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  /* avatar arc container */
  .avatar svg{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

  /* quick ws log (small, at bottom of topbar) */
  .ws-log {
    font-family: monospace;
    font-size:12px;
    color: #ddd;
    background: rgba(0,0,0,0.25);
    padding:8px 10px;
    border-radius:8px;
    margin-top:6px;
    width:100%;
    max-height:120px;
    overflow:auto;
    box-sizing:border-box;
  }

  /* notif below top bar (slides right in/out) */
  .notif {
    width: calc(100% - 40px);
    max-width:720px;
    margin:8px auto 0;
    display:flex;
    gap:12px;
    align-items:center;
    padding:10px 14px;
    background: linear-gradient(90deg,#222,#111);
    color:#fff;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,0.45);
    transform: translateX(120%);
    opacity:0;
    transition: transform .42s cubic-bezier(.2,.9,.3,1), opacity .28s;
    pointer-events:none;
    z-index:120;
  }
  .notif.show{ transform: translateX(0); opacity:1; pointer-events:auto; }
  .notif.hide{ transform: translateX(120%); opacity:0; pointer-events:none; }
  .notif img{ width:40px;height:40px;border-radius:50%;object-fit:cover; }
  .notif .text{ font-weight:800; font-size:14px; }

  /* slot reel two-box number display */
  .number-row{
    width:100%;
    display:flex;
    justify-content:center;
    gap:18px;
    align-items:center;
    pointer-events:none;
    margin-top:6px;
  }
  .slot-box{
    width:140px;
    max-width:36%;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    box-shadow: 0 12px 30px rgba(0,0,0,0.22);
    display:flex;align-items:center;justify-content:center;overflow:hidden;padding:10px; position:relative;
  }
  .digit-viewport{ width:100%; height:64px; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:10px; background:#111; color:#fff; }
  .digit-strip{ display:flex; flex-direction:column; align-items:center; width:100%; transform:translateY(0); }
  .digit{ height:64px; display:flex; align-items:center; justify-content:center; width:100%; font-weight:900; font-size:40px; color:#fff; }
  .digit.static{ padding:6px 8px; font-size:44px; }

  /* TICKET FRAME (black outer border like reference) */
  .ticket-frame{
    width: var(--ticket-width-mobile);
    margin-left:10%;
    margin-right:10%;
    box-sizing:border-box;
    padding:10px; /* inner padding that becomes white margin inside black frame */
    background: var(--black-frame); /* thick outer frame */
    border-radius:12px;
    box-shadow: 0 16px 60px rgba(0,0,0,0.65);
  }
  @media(min-width:900px){
    .ticket-frame{ width: var(--ticket-width-desktop); margin-left:25%; margin-right:25%; }
  }

  /* inner ticket panel (white-ish area where title & grid live) */
  .ticket-card{
    width:100%;
    background: #fff; /* clean white inner area like printed ticket */
    border-radius:8px;
    padding:10px 12px;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  /* ticket top title area */
  .ticket-title{
    width:100%;
    text-align:center;
    font-weight:800;
    letter-spacing:0.6px;
    color:#111;
    font-size:clamp(16px,2.4vw,22px);
    padding:6px 0;
    border-bottom: 2px solid rgba(0,0,0,0.06);
  }

  /* grid styling to mimic printed ticket: subtle thin internal borders, peach filled cells */
  .ticket{
    width:100%;
    display:grid;
    grid-template-columns: repeat(9, 1fr);
    gap:6px;
    padding:10px 6px;
    box-sizing:border-box;
    background:transparent;
    justify-items:center;
    align-items:center;
  }

  /* each cell: perfectly square via aspect-ratio, slightly rounded */
  .cell{
    width:100%;
    max-width:var(--cell-max);
    aspect-ratio: 1/1;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    border-radius:6px;
    border: 1px solid rgba(0,0,0,0.18);
    font-weight:900;
    color:#111;
    font-size:clamp(14px,2.1vw,24px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.08), inset 0 -3px 0 rgba(0,0,0,0.02);
    position:relative;
  }

  /* mimic the 'dot' style tambola cell (small dot in empty cells) */
  .cell.empty::after{
    content: "";
    width:10px; height:10px;
    border-radius:50%;
    background: rgba(0,0,0,0.18);
    position:absolute;
    bottom:8px;
    right:8px;
    opacity:0.85;
  }

  /* filled (number) cells in peach */
  .cell.filled{
    background: var(--peach);
    color:#111;
    border-color: rgba(0,0,0,0.18);
    box-shadow: 0 8px 18px rgba(0,0,0,0.08);
  }

  /* called style (green overlay) */
  .cell.called{
    background: linear-gradient(90deg,#d9f6e7,#bff0c4);
    color:#00331a;
    border-color: rgba(0,0,0,0.12);
    transform: translateY(-3px);
    box-shadow: 0 18px 36px rgba(0,0,0,0.08);
  }

  /* simplified ticket footer */
  .ticket-foot{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:700;
    color:#111;
    font-size:12px;
    padding:6px 4px 4px;
    opacity:.95;
  }

  /* bottom controls: two buttons stacked vertically and called badge */
  .bottom-bar{
    width:100%;
    max-width:980px;
    display:flex;
    gap:14px;
    justify-content:center;
    align-items:center;
    margin-top:6px;
  }
  .controls{ display:flex; flex-direction:column; gap:10px; width:200px; }
  .btn{ border:none; padding:12px 14px; border-radius:12px; font-weight:800; cursor:pointer; width:100%; }
  .btn.numbers{ background: linear-gradient(90deg,#ffd54f,#ff8a65); color:#111; box-shadow:0 10px 26px rgba(0,0,0,0.18); }
  .btn.leader{ background: linear-gradient(90deg,#4fc3f7,#3f51b5); color:#fff; box-shadow:0 10px 26px rgba(0,0,0,0.18); }
  .called-badge{ background: rgba(255,255,255,0.06); color:#fff; padding:10px 14px; border-radius:12px; font-weight:800; min-width:140px; text-align:center; }

  /* overlays (numbers & leaderboard) */
  .backdrop{
    position:fixed; inset:0; background: rgba(3,10,40,0.6); display:none; align-items:center; justify-content:center; z-index:12000; backdrop-filter: blur(6px);
  }
  .backdrop.show{ display:flex; }
  .panel{
    width:92%; max-width:980px; max-height:86vh; overflow:auto; padding:18px; border-radius:12px; background: rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.06);
  }
  .numbers-grid{ display:grid; gap:10px; justify-items:center; align-items:center; }
  @media(min-width:720px){ .numbers-grid{ grid-template-columns: repeat(10, 1fr); } }
  @media(max-width:719px){ .numbers-grid{ grid-template-columns: repeat(8, 1fr); } }
  .numbers-grid .num{ width:100%; aspect-ratio:1/1; max-width:72px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900; font-size:14px; border-radius:10px; background: linear-gradient(180deg,#b71c1c,#c62828); box-shadow:0 10px 28px rgba(0,0,0,0.45); }
  .numbers-grid .num.called{ background: linear-gradient(180deg,#2e7d32,#43a047); transform: translateY(-3px); }

  /* leader rows */
  .leader-row{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; background: rgba(255,255,255,0.02); margin-bottom:8px; }
  .leader-row img{ width:56px; height:56px; border-radius:50%; object-fit:cover; }

  /* portrait warning overlay */
  .portrait-warning {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 16000;
    pointer-events: auto;
  }
  .portrait-warning .bg {
    position: absolute;
    inset: 0;
    background: rgba(2,8,24,0.85);
    -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
  }
  .portrait-warning .card {
    position: relative;
    z-index: 16001;
    width: min(94%, 540px);
    margin: 12px;
    background: linear-gradient(180deg,#fff,#f7f7f7);
    color:#111;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.6);
    text-align:center;
    font-weight:700;
  }
  .portrait-warning .card h3{ margin:0 0 8px; font-size:18px; }
  .portrait-warning .card p{ margin:6px 0 16px; font-weight:600; color:#222; opacity:0.95; }
  .portrait-warning .card .actions{ display:flex; gap:10px; justify-content:center; margin-top:6px; }
  .portrait-warning .card .actions button{ padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }
  .portrait-warning .card .rotate { background: linear-gradient(90deg,#4fc3f7,#3f51b5); color:#fff; }
  .portrait-warning .card .continue { background: linear-gradient(90deg,#ffd54f,#ff8a65); color:#111; }

  /* small screens */
  @media(max-width:520px){
    :root{ --cell-max:64px; }
    .slot-box{ width:110px; }
    .digit{ font-size:30px; height:52px; min-height:52px; }
    .digit-viewport{ height:52px; }
    .controls{ width:160px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top-bar" id="topBar" aria-live="polite"></div>

    <!-- ws debug log (tiny, non-intrusive) -->
    <div id="wsLog" class="ws-log" aria-hidden="false" style="display:none;"></div>

    <!-- notification area (appears below top bar) -->
    <div id="notif" class="notif" aria-live="polite" role="status" style="display:flex;align-items:center;">
      <img id="notifIcon" src="" alt="">
      <div class="text" id="notifText"></div>
    </div>

    <!-- two-box slot reel -->
    <div class="number-row" aria-hidden="true">
      <div class="slot-box">
        <div class="digit-viewport" id="tensViewport"><div class="digit static" id="tensStatic">-</div></div>
      </div>
      <div class="slot-box">
        <div class="digit-viewport" id="unitsViewport"><div class="digit static" id="unitsStatic">-</div></div>
      </div>
    </div>

    <!-- TICKET FRAME (outer black) -->
    <div class="ticket-frame" aria-hidden="false">
      <div class="ticket-card" role="region" aria-label="Tambola ticket">
        <div class="ticket-title">Tambola ticket No : <span id="ticketNo">1</span></div>

        <!-- ticket grid -->
        <div class="ticket" id="ticket" role="grid" aria-label="Tambola ticket"></div>

        <div class="ticket-foot">
          <div>SN: TB-2025-001</div>
          <div>5 numbers per row â€¢ 15 numbers total</div>
        </div>
      </div>
    </div>

    <!-- bottom controls -->
    <div class="bottom-bar">
      <div class="called-badge" id="calledBadge">Called: 0 / 90</div>
      <div class="controls">
        <button class="btn numbers" id="openNumbersBtn">Show Numbers</button>
        <button class="btn leader" id="openLeaderboardBtn">Leaderboard</button>
        <!-- host controls (shown when host) -->
        <button class="btn" id="startBtn" style="display:none;background:#4caf50;color:#fff;margin-top:6px;">Start Game</button>
        <button class="btn" id="sendNumBtn" style="display:none;background:#1976d2;color:#fff;margin-top:6px;">Call Number (host)</button>
      </div>
    </div>
  </div>

  <!-- overlays -->
  <div class="backdrop" id="numbersBackdrop" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="numbersTitle">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <h2 id="numbersTitle" style="color:#fff;margin:0;">All Numbers (1â€“90)</h2>
        <button id="closeNumbersBtn" style="background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;">âœ•</button>
      </div>
      <div class="numbers-grid" id="numbersGrid" aria-live="polite"></div>
    </div>
  </div>

  <div class="backdrop" id="leaderBackdrop" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="leaderTitle">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <h2 id="leaderTitle" style="color:#fff;margin:0;">Leaderboard</h2>
        <button id="closeLeaderBtn" style="background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;">âœ•</button>
      </div>
      <div id="leaderList" style="max-height:70vh; overflow:auto;"></div>
    </div>
  </div>

  <!-- center achievement -->
  <div class="backdrop center-ach-overlay" id="centerAch" style="display:none;">
    <div style="position:absolute;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(6px)"></div>
    <div style="background:#fff;padding:18px 20px;border-radius:10px;z-index:3;"><strong id="centerText">Achievement</strong></div>
  </div>

  <!-- PORTRAIT WARNING -->
  <div id="portraitWarning" class="portrait-warning" aria-hidden="true" role="dialog" aria-modal="true" aria-live="assertive">
    <div class="bg"></div>
    <div class="card" role="document">
      <h3>Best in Landscape</h3>
      <p>This interface is optimized for landscape. Rotate your device for the best experience.</p>
      <div class="actions">
        <button class="rotate" id="rotateBtn" title="Rotate device">Rotate</button>
        <button class="continue" id="continueBtn" title="Continue anyway">Continue anyway</button>
      </div>
    </div>
  </div>

  <!-- small hidden svg gradient for avatar arcs -->
  <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px">
    <defs>
      <linearGradient id="arcGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stop-color="#ffd54f"/><stop offset="50%" stop-color="#ff8a65"/><stop offset="100%" stop-color="#ff3d00"/>
      </linearGradient>
    </defs>
  </svg>

<script>
/* ---------- WebSocket & App state ---------- */
// NOTE: change WS URL if you use another host
const WS_URL = "wss://multiplyer-game.onrender.com";
let ws = null;

// Player / UI state
let playersMap = {};            // keyed by playerId: {playerId, username, icon, achievement}
let playerAchievements = {};    // map playerId -> Set(achievements)
const achievementNames = ['None','First five','First seven','First row','Second row','Third row','Full house'];
let ticketGrid = null;          // 3x9 array of { number|null, called, row }
const calledSet = new Set();
let called_numbers = 0, row1=0,row2=0,row3=0;
let awarded = {firstFive:false,firstSeven:false,row1:false,row2:false,row3:false,fullHouse:false};
const ticketOwnerIndex = 0; // will not be used to send awards; server normally decides winners

// local tokens from localStorage (as your other file used)
const roomId = localStorage.getItem("roomId");
const playerId = localStorage.getItem("playerId") || ('local-' +
